#!/bin/sh -f

# This shell-script generates the derived tables from pl-vmi.c, the file
# providing the virtual machine instructions.
# 
# TBD: Include #ifdef/#endif in output?

in=pl-vmi.c
ctable=pl-codetable.c
jtable=pl-jumptable.ic
ctype=pl-vmi.h

PAT="^\(VMI(\)"

################################################################
# pl-codetable.c
################################################################

cat > $ctable.new << EOS
/*  File: $ctable

    This file provides a description of the virtual machine instructions
    and their arguments. It  is  used by  pl-comp.c  to facilitate the
    compiler and decompiler, as well as pl-wic.c to save/reload sequences
    of virtual machine instructions.

    Note: this file is generated by $0 from $in.  DO NOT EDIT
*/

#include "pl-incl.h"

const code_info codeTable[] = {
/* ID #args #argtype */
EOS
grep "$PAT" $in | sed \
	-e 's/^VMI(\([A-Z_0-9]*\), *\([A-Z_0-9]*\), *(\(.*\)) *)/  { "\1", \1, \2, {\3} },/' >> $ctable.new
cat >> $ctable.new << EOS
  { NULL, 0, 0, {} }
};
EOS

################################################################
# pl-jumptable.ic
################################################################

cat > $jtable.new << EOS
/*  File: $jtable

    This file provides the GCC-2 jump-labels to exploit GCC's
    support for threaded code.

    Note: this file is generated by $0 from $in.  DO NOT EDIT
*/

  static void *jmp_table[] =
  {
EOS

grep "$PAT" $in |
	sed "s/^VMI(\([A-Z_0-9]*\), *\([A-Z_0-9]*\).*/    \&\&\1_LBL,/" >> $jtable.new

cat >> $jtable.new << EOS
    NULL
  };
EOS

################################################################
# pl-code.h
################################################################

cat > $ctype.new << EOS
/*  File: $ctype

    This file provides the definition of type code.

    Note: this file is generated by $0 from $in.  DO NOT EDIT
*/

typedef enum
{
EOS

grep "$PAT" $in |
	sed "s/^VMI(\([A-Z_0-9]*\), *\([A-Z_0-9]*\).*/  \1,/" >> $ctype.new

cat >> $ctype.new << EOS
  VMI_END_LIST
} vmi;

#define I_HIGHEST ((int)VMI_END_LIST)

EOS

#		 /*******************************
#		 *	       UPDATE		*
#		 *******************************/

updateifnew ()
{ file="$1"

  if cmp -s $file.new $file; then
     rm $file.new
  else
     mv $file.new $file
     echo "Updated $file"
  fi
}

updateifnew $ctable
updateifnew $jtable
updateifnew $ctype
