#!/bin/sh -f

# This shell-script generates the derived tables from pl-vmi.c, the file
# providing the virtual machine instructions.
# 
# TBD: Include #ifdef/#endif in output?

in=pl-vmi.c
ctable=pl-codetable.c
jtable=pl-jumptable.ic
ctype=pl-vmi.h

PAT="^\(VMI(\)"

################################################################
# pl-codetable.c
################################################################

cat > $ctable << EOS
/*  File: $ctable

    This file provides a description of the virtual machine instructions
    and their arguments. It  is  used by  pl-comp.c  to facilitate the
    compiler and decompiler, as well as pl-wic.c to save/reload sequences
    of virtual machine instructions.

    Note: this file is generated by $0 from $in.  DO NOT EDIT
*/

#include "pl-incl.h"

#define CODE(vmi, ac, at) { #vmi, vmi, ac, at }

const code_info codeTable[] = {
/* ID #args #argtype */
EOS
grep "$PAT" $in |
	sed "s/^VMI(\([A-Z_0-9]*\), *\([A-Z_0-9]*\), *\([A-Z_0-9]*\))/  CODE(\1, \2, \3),/" >> $ctable
cat >> $ctable << EOS
  { NULL, 0, 0, 0 }
};
EOS


################################################################
# pl-jumptable.ic
################################################################

cat > $jtable << EOS
/*  File: $jtable

    This file provides the GCC-2 jump-labels to exploit GCC's
    support for threaded code.

    Note: this file is generated by $0 from $in.  DO NOT EDIT
*/

  static void *jmp_table[] =
  {
EOS

grep "$PAT" $in |
	sed "s/^VMI(\([A-Z_0-9]*\), *\([A-Z_0-9]*\), *\([A-Z_0-9]*\))/    \&\&\1_LBL,/" >> $jtable

cat >> $jtable << EOS
    NULL
  };
EOS


################################################################
# pl-code.h
################################################################

cat > $ctype << EOS
/*  File: $ctype

    This file provides the definition of type code.

    Note: this file is generated by $0 from $in.  DO NOT EDIT
*/

typedef enum
{
EOS

grep "$PAT" $in |
	sed "s/^VMI(\([A-Z_0-9]*\), *\([A-Z_0-9]*\), *\([A-Z_0-9]*\))/  \1,/" >> $ctype

cat >> $ctype << EOS
  VMI_END_LIST
} vmi;

#define I_HIGHEST ((int)VMI_END_LIST)

EOS
